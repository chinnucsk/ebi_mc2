# 1. Introduction

This directory contains the linux-server-side scripts for the `EBI_MC2`
Erlang-SLURM integration.


# 2. Scripts and related files

The following scripts are invoked by SLURM:
    bio-solver
    bio-solver-sup.awk
    cleanup
The scripts are referenced from the slurm batch scripts, generated by the
`cluster`. The scripts are running in the cluster nodes.

The following script is used as an interface between the Erlang server and the
SLURM:
    cluster
This script is invoked by the Erlang over SSH and actually runs on the control
node of the cluster:

The following script is used for auto-login from the `uosis.mif.vu.lt` to the
control node of the cluster:
    cluster-shell
This script is running on the uosis.mif.vu.lt, and is referenced via the ssh's
`~/.ssh/authorized_keys` as a login command and is invoked when the Erlang connects
to the uosis.mif.vu.lt via SSH with appropriate key. This script works like
a proxy or a shell allowing direct interaction of the Erlang with the `cluster`
script on the cluster control node.

Both the scripts `cluster` and `cluster-shell` are configured via `~/.clusterrc`
file. The path to the shared cluster filesystem is also hardcoded in the Makefile.

Other related files include:
  * `~/PST/`
        This directory. It is used to serve script bin/cluster on the cluster and
        bin/cluster-shell on the uosis.mif.vu.lt.
  * `~/PST/biosensor-0.6.6-amd64-debian-6.0.4/`
        Biosensor solver binaries, compiled for the amd64 architecture on the Debian
        version 6.0.4. These binaries are then copied to the cluster shared filesystem
        and used from the computing cluster nodes.
  * `~/PST/Makefile`
        Some automations for the installation of this software.
  * `/scratch/lustre/karolis/PST/`
        Is used as a working directory for the cluster managed jobs. It is accessible
        in the cluster only.
  * `~/.hushlogin`
        Is used to disable the ssh login banner.
        Used in both the uosis.mif.vu.lt and the cluster control node.
  * `~/.ssh/authorized_keys`
        Is used on the uosis.mif.vu.lt to authorize Erlang login to this
        server and automatically invoke the bin/cluster-shell used to create
        proxy to the SLURM cluster.
  * `~/.clusterrc`
        Cluster control script configuration file.
        

# 3. Installation

For now the installation is semi-automated.
 1. Make sure the directory containing this README is in ~/PST on the uosis.mif.vu.lt.
 2. Run `make install` in ~/PST on the cluster control node to create needed structure
    in the shared cluster filesystem (/scratch/lustre/karolis/PST).
 3. Create empty ~/.hushlogin on the uosis.mif.vu.lt.
 4. Edit `~/.ssh/authorized_keys` on the uosis.mif.vu.lt by adding a line similar to the
    following: `command="/users3/karolis/PST/bin/cluster-shell",no-port-forwarding,
    no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa ... bio_ers_queue_mif2_ssh@karolis-home`.
 5. You can test the connection now by invoking the following command from the client server:
    `ssh -T -i etc/ssh/id_rsa uosis.mif.vu.lt`. It should connect you to the cluster
    host instead of the intermediary uosis.mif.vu.lt.


# References
[1]: https://computing.llnl.gov/linux/slurm/man_index.html


# Apendix A. Some commands
To show a list of running tasks:
    squeue

To run a task:
    PST=/scratch/lustre/karolis/PST; srun --chdir=/tmp $PST/bin/bio-solver $PST/data/kape1395.str_nanotubes_wo_M/model-1D-k2fin-t6.xml $PST/data/t1

